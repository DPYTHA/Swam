<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord - Livreur</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f8f9fa;
      color: #333;
    }

    header {
      background-color: orangered;
      padding: 15px 20px;
      color: white;
      text-align: center;
      font-size: 1.3rem;
    }

    .container {
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }

    .tracking-line {
      display: flex;
      justify-content: space-between;
      position: relative;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }

    .step {
      flex: 1;
      min-width: 60px;
      text-align: center;
      position: relative;
      margin-bottom: 15px;
    }

    .step .icon {
      width: 50px;
      height: 50px;
      line-height: 50px;
      border-radius: 50%;
      background-color: #ddd;
      color: #fff;
      margin: auto;
      font-size: 20px;
    }

    .step.completed .icon {
      background-color: orangered;
    }

    .step .label {
      margin-top: 10px;
      font-size: 0.95rem;
    }

    .tracking-line::before {
      content: '';
      position: absolute;
      top: 25px;
      left: 10%;
      right: 10%;
      height: 4px;
      background-color: #ccc;
      z-index: 0;
    }

    .btn-step {
      margin: 8px 5px;
      padding: 10px 20px;
      background-color: orangered;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
    }

    .btn-step:disabled {
      background-color: #8b0404;
      cursor: not-allowed;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .top-bar > div,
    .top-bar > button {
      flex: 1 1 48%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .hidden {
      display: none;
    }

    #codeForm {
      margin-bottom: 20px;
      text-align: center;
    }

    #codeForm input {
      padding: 10px;
      font-size: 1rem;
      width: 60%;
      margin-right: 10px;
    }

    #codeForm button {
      padding: 10px 20px;
      font-size: 1rem;
    }

    @media (max-width: 600px) {
      .tracking-line {
        flex-direction: column;
        align-items: center;
      }

      .step {
        width: 100%;
      }

      .top-bar {
        flex-direction: column;
      }

      .btn-step {
        width: 100%;
        font-size: 1rem;
      }

      .tracking-line::before {
        display: none;
      }
    }
  </style>
</head>
<body>
  <header>
    Votre Tableau de bord  üöö
  </header>
  <div style="text-align: center; margin-top: 10px; font-size: 1.1rem;">
    <span id="userDisplay"></span>
  </div>

  <div class="container">


    <h2>Suivi de livraison</h2>

    <form id="codeForm">
      <input type="text" id="inputCode" placeholder="Entrez un code de suivi">
      <button type="submit" class="btn-step">Charger Mission</button>
    </form>

    <div id="mission-box" style="margin-bottom: 30px; padding: 15px; border: 2px dashed orangered; border-radius: 8px; display: none;">
      <h3 style="color: orangered;">üì¶ Mission actuelle</h3>
      <p><strong>Code de suivi :</strong> <span id="codeSuivi"></span></p>
      <p><strong>Type :</strong> <span id="typeLivraison"></span></p>
      <p><strong>Description :</strong> <span id="descriptionLivraison"></span></p>
      <p><strong>Adresse d√©part :</strong> <span id="adresseDepart"></span></p>
      <p><strong>Adresse arriv√©e :</strong> <span id="adresseArrivee"></span></p>
    </div>

    <div class="tracking-line" id="tracking-line">
      <div class="step" data-step="0">
        <div class="icon"><i class="fas fa-check"></i></div>
        <div class="label">Confirm√©e</div>
      </div>
      <div class="step" data-step="1">
        <div class="icon"><i class="fas fa-cogs"></i></div>
        <div class="label">Traitement</div>
      </div>
      <div class="step" data-step="2">
        <div class="icon"><i class="fas fa-truck"></i></div>
        <div class="label">En livraison</div>
      </div>
      <div class="step" data-step="3">
        <div class="icon"><i class="fas fa-box"></i></div>
        <div class="label">Livr√©(e)</div>
      </div>
    </div>

    <button id="next-step-btn" class="btn-step">√âtape suivante</button>
  </div>

  <script>
  const steps = document.querySelectorAll('.step');
  const nextBtn = document.getElementById('next-step-btn');
  let currentStep = parseInt(localStorage.getItem('livraisonEtape')) || 0;
 let codeActuel = null;  // Pour suivre le code de mission en cours
  function updateUI() {
    steps.forEach((step, index) => {
      step.classList.toggle('completed', index <= currentStep);
    });

    if (currentStep >= steps.length - 1) {
      nextBtn.disabled = true;
      document.querySelector('.tracking-line').classList.add('hidden');
      localStorage.removeItem('livraisonEtape');
    }
  }

  nextBtn.addEventListener('click', () => {
    if (currentStep < steps.length - 1) {
      currentStep++;
      localStorage.setItem('livraisonEtape', currentStep);
      updateUI();
    }
  });

  updateUI();


 

// Modifie l‚ÄôupdateUI pour faire aussi une requ√™te serveur
function updateUI() {
  steps.forEach((step, index) => {
    step.classList.toggle('completed', index <= currentStep);
  });

  // Envoie la progression au serveur (client verra le changement)
  if (codeActuel) {
    fetch('/api/update_etape', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        code_suivi: codeActuel,
        etape: currentStep
      })
    });
  }

  if (currentStep >= steps.length - 1) {
    nextBtn.disabled = true;
    document.querySelector('.tracking-line').classList.add('hidden');
    localStorage.removeItem('livraisonEtape');
  }
}


  const dispoOnBtn = document.getElementById('disponibleOn');
  const dispoOffBtn = document.getElementById('disponibleOff');
  let isDisponible = localStorage.getItem("livreurDisponible") === "true";

  function updateDisponibiliteUI() {
    dispoOnBtn.style.opacity = isDisponible ? "1" : "0.5";
    dispoOffBtn.style.opacity = !isDisponible ? "1" : "0.5";
  }

  dispoOnBtn.addEventListener('click', () => {
    isDisponible = true;
    localStorage.setItem("livreurDisponible", "true");
    updateDisponibiliteUI();
    notifyServeurDisponibilite(true);
  });

  dispoOffBtn.addEventListener('click', () => {
    isDisponible = false;
    localStorage.setItem("livreurDisponible", "false");
    updateDisponibiliteUI();
    notifyServeurDisponibilite(false);
  });

  function notifyServeurDisponibilite(dispo) {
    fetch('/livreur/disponibilite', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ disponible: dispo })
    });
  }

  updateDisponibiliteUI();

document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.clear();
  fetch("/logout", { method: "GET" }).then(() => {
    window.location.href = "/home";
  });
  });

  const userSpan = document.getElementById('userDisplay');
  let nom = localStorage.getItem('nomUtilisateur');

  if (nom) {
    userSpan.innerHTML = `<i class="fas fa-user-circle"></i> Bonjour ${nom}`;
  } else {
    fetch('/user-info')
      .then(res => res.json())
      .then(data => {
        if (data.prenom) {
          nom = data.prenom;
          localStorage.setItem('nomUtilisateur', nom);
          userSpan.innerHTML = `<i class="fas fa-user-circle"></i> Bonjour ${nom}`;
        }
      });
  }

  // Charger mission manuellement
 document.getElementById("codeForm").addEventListener("submit", function (e) {
  e.preventDefault();

  const code = document.getElementById("inputCode").value;
  if (!code) return;

  fetch(`/mission_livreur?code=${code}`)
    .then(res => res.json())
    .then(data => {
      if (data.code) {
        codeActuel = data.code;  // ‚úÖ Maintenant ici, apr√®s r√©ception de la r√©ponse
        currentStep = parseInt(localStorage.getItem('livraisonEtape')) || 0;
        updateUI();

        const box = document.getElementById('mission-box');
        box.style.display = 'block';
        document.getElementById('codeSuivi').textContent = data.code;
        document.getElementById('typeLivraison').textContent = data.type;
        document.getElementById('descriptionLivraison').textContent = data.description;
        document.getElementById('adresseDepart').textContent = data.depart;
        document.getElementById('adresseArrivee').textContent = data.arrivee;

        // ‚úÖ Assignation mission
        fetch('/assigner_mission', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: data.code })
        })
        .then(r => r.json())
        .then(resp => {
          console.log("Assignation :", resp.message || "R√©ponse inconnue");
        })
        .catch(err => {
          console.error("Erreur assignation mission :", err);
        });

      } else {
        document.getElementById('mission-box').innerHTML = `<p style="color: gray;">Mission introuvable pour ce code.</p>`;
      }
    })
    .catch(err => {
      console.error("Erreur r√©cup√©ration mission :", err);
    });
});


</script>

</body>
</html>
